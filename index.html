<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LINE Flex Promo Sender</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --green: #06C755;
    --green-dark: #04a344;
    --black: #0a0a0a;
    --surface: #111;
    --surface2: #1a1a1a;
    --border: #2a2a2a;
    --text: #f0f0f0;
    --text-muted: #666;
    --accent: #FFE500;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--black);
    color: var(--text);
    font-family: 'Noto Sans Thai', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    background: var(--black);
    z-index: 10;
  }

  .logo {
    width: 36px;
    height: 36px;
    background: var(--green);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    font-size: 14px;
    color: white;
    flex-shrink: 0;
  }

  header h1 {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
  }

  header p {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 1px;
  }

  /* LIFF ID Setup */
  #setup-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px 24px;
    gap: 24px;
  }

  .setup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px 24px;
    width: 100%;
    max-width: 440px;
  }

  .setup-card h2 {
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 8px;
  }

  .setup-card p {
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.6;
    margin-bottom: 24px;
  }

  /* Main App */
  #app {
    display: none;
    flex: 1;
    flex-direction: column;
    max-width: 600px;
    margin: 0 auto;
    width: 100%;
    padding: 24px 16px;
    gap: 24px;
  }

  section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  .section-label {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.1em;
    color: var(--green);
    text-transform: uppercase;
    font-family: 'Space Mono', monospace;
  }

  .fields {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  label {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 600;
  }

  input, textarea, select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'Noto Sans Thai', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  input:focus, textarea:focus, select:focus {
    border-color: var(--green);
  }

  textarea {
    resize: vertical;
    min-height: 80px;
  }

  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  /* Color Picker */
  .color-options {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .color-swatch {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
  }

  .color-swatch.active {
    border-color: white;
    transform: scale(1.1);
  }

  /* Preview */
  #preview-wrap {
    padding: 16px;
  }

  .bubble-preview {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    max-width: 320px;
    margin: 0 auto;
  }

  .preview-hero {
    width: 100%;
    aspect-ratio: 20/13;
    object-fit: cover;
    display: block;
  }

  .preview-hero-placeholder {
    width: 100%;
    aspect-ratio: 20/13;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    color: rgba(255,255,255,0.6);
    font-weight: 600;
    position: relative;
  }

  .preview-body {
    padding: 16px;
  }

  .preview-tag {
    display: inline-block;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 3px 8px;
    border-radius: 4px;
    margin-bottom: 8px;
    color: white;
  }

  .preview-title {
    font-size: 18px;
    font-weight: 900;
    color: #1a1a1a;
    line-height: 1.3;
    margin-bottom: 4px;
  }

  .preview-desc {
    font-size: 12px;
    color: #888;
    line-height: 1.5;
    margin-bottom: 12px;
  }

  .preview-price-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 14px;
  }

  .preview-price {
    font-size: 22px;
    font-weight: 900;
    color: #e11d48;
  }

  .preview-original {
    font-size: 13px;
    color: #bbb;
    text-decoration: line-through;
  }

  .preview-badge {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 7px;
    border-radius: 999px;
    color: white;
    background: #e11d48;
  }

  .preview-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    color: white;
    cursor: default;
    text-align: center;
    font-family: 'Noto Sans Thai', sans-serif;
  }

  /* Send Button */
  .send-btn {
    background: var(--green);
    border: none;
    border-radius: 14px;
    padding: 16px;
    color: white;
    font-size: 16px;
    font-weight: 700;
    font-family: 'Noto Sans Thai', sans-serif;
    cursor: pointer;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
    letter-spacing: 0.02em;
  }

  .send-btn:hover { background: var(--green-dark); transform: translateY(-1px); }
  .send-btn:active { transform: translateY(0); }
  .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .btn-primary {
    background: var(--green);
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    color: white;
    font-size: 14px;
    font-weight: 700;
    font-family: 'Noto Sans Thai', sans-serif;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s;
  }

  .btn-primary:hover { background: var(--green-dark); }

  /* Status */
  #status {
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    display: none;
    margin-top: 4px;
    text-align: center;
  }

  #status.success { background: #052e16; color: #4ade80; border: 1px solid #166534; display: block; }
  #status.error   { background: #2d0a0a; color: #f87171; border: 1px solid #7f1d1d; display: block; }
  #status.info    { background: #0a1628; color: #60a5fa; border: 1px solid #1e3a5f; display: block; }

  .tip {
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
    padding: 0 8px;
    line-height: 1.6;
  }

  .tip a { color: var(--green); text-decoration: none; }

  /* Bottom padding */
  .spacer { height: 32px; }

  select option { background: #1a1a1a; }

  /* ===== NEW: Type Selector ===== */
  .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .type-btn {
    background: var(--surface2); border: 2px solid var(--border);
    border-radius: 12px; padding: 12px 10px; cursor: pointer;
    display: flex; align-items: center; gap: 10px;
    transition: all 0.15s; user-select: none;
  }
  .type-btn.active { border-color: var(--green); background: rgba(6,199,85,0.08); }
  .type-btn .t-icon { font-size: 22px; }
  .type-btn .t-label { font-size: 13px; font-weight: 700; }
  .type-btn .t-sub { font-size: 10px; color: var(--text-muted); }

  .msg-section { display: none; }
  .msg-section.visible { display: block; }

  /* ===== NEW: Carousel tabs ===== */
  .section-label-row {
    padding: 14px 16px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .section-label-row .section-label { padding: 0; border: none; }
  .card-count-wrap { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); }
  .card-count-wrap select { width: 60px; padding: 4px 8px; font-size: 12px; }

  .card-tabs { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
  .card-tab {
    padding: 5px 14px; border-radius: 20px; font-size: 12px; font-weight: 700;
    cursor: pointer; border: 1px solid var(--border); background: var(--surface2);
    color: var(--text-muted); transition: all 0.15s;
  }
  .card-tab.active { background: var(--green); border-color: var(--green); color: white; }
  .card-form { display: none; }
  .card-form.visible { display: flex; flex-direction: column; gap: 14px; }

  /* ===== NEW: Button list ===== */
  .btn-list { display: flex; flex-direction: column; gap: 8px; }
  .btn-item {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px; display: flex; flex-direction: column; gap: 10px;
  }
  .btn-item-header {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 11px; color: var(--text-muted); font-weight: 700;
  }
  .remove-btn { background: none; border: none; color: #f87171; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; }
  .add-field-btn {
    background: var(--surface2); border: 1px dashed var(--border);
    border-radius: 10px; padding: 10px; color: var(--green);
    font-size: 13px; font-weight: 700; cursor: pointer; width: 100%;
    font-family: 'Noto Sans Thai', sans-serif; transition: all 0.15s;
  }
  .add-field-btn:hover { border-color: var(--green); }

  /* ===== NEW: Carousel preview ===== */
  .carousel-preview-scroll {
    display: flex; gap: 12px; overflow-x: auto; padding: 16px;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
  }
  .carousel-preview-scroll .bubble-preview { flex-shrink: 0; width: 260px; max-width: none; margin: 0; }
  .preview-btn { margin-top: 6px; }
  .preview-btn-secondary {
    width: 100%; padding: 10px; border-radius: 10px; font-size: 13px; font-weight: 700;
    cursor: default; text-align: center; font-family: 'Noto Sans Thai', sans-serif;
    background: white; border: 1.5px solid; margin-top: 6px;
  }
  .preview-btn-link { text-align: center; padding: 8px; font-size: 13px; font-weight: 700; cursor: default; margin-top: 4px; }
</style>
</head>
<body>

<header>
  <div class="logo">FX</div>
  <div>
    <h1>Flex Promo Sender</h1>
    <p>‡∏™‡πà‡∏á Flex Message ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
  </div>
</header>

<!-- Setup Screen -->
<div id="setup-screen">
  <div class="setup-card">
    <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF ID</h2>
    <p>‡∏Å‡∏£‡∏≠‡∏Å LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô<br>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà LINE Developers Console ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å LIFF ‚Üí Add<br>‡∏ï‡∏±‡πâ‡∏á Scope ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î <strong>chat_message.write</strong></p>
    <label>
      LIFF ID
      <input id="liff-id-input" type="text" placeholder="1234567890-xxxxxxxx" />
    </label>
    <br>
    <button class="btn-primary" onclick="initLiff()">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE</button>
    <div id="status"></div>
    <br>
    <p class="tip">
      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ LIFF? <a href="https://developers.line.biz/console/" target="_blank">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà LINE Developers</a>
    </p>
  </div>
</div>

<!-- Main App -->
<div id="app">

  <!-- FLEX SECTION -->
  <section class="msg-section visible" id="section-flex">
    <div class="section-label-row">
      <div class="section-label">‚ú® ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô (Flex)</div>
      <div class="card-count-wrap">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î:
        <select id="card-count" onchange="updateCardCount()">
          <option>1</option><option>2</option><option>3</option>
          <option>4</option><option>5</option><option>6</option>
        </select>
      </div>
    </div>
    <div class="fields">
      <div class="card-tabs" id="card-tabs"></div>
      <div id="cards-container"></div>
    </div>
  </section>

  <!-- Preview -->
  <section id="preview-section">
    <div class="section-label">üëÅ Preview</div>
    <div id="preview-wrap">
      <div class="bubble-preview" id="bubble-preview"></div>
    </div>
  </section>

  <!-- TYPE SELECTOR -->
  <section>
    <div class="section-label">üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° <span style="font-size:10px;color:var(--text-muted);text-transform:none;letter-spacing:0;font-family:sans-serif">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á)</span></div>
    <div class="fields">
      <div class="type-grid">
        <div class="type-btn" id="type-text" onclick="toggleType('text')">
          <span class="t-icon">üí¨</span><div><div class="t-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div><div class="t-sub">Text</div></div>
        </div>
        <div class="type-btn" id="type-image" onclick="toggleType('image')">
          <span class="t-icon">üñºÔ∏è</span><div><div class="t-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div><div class="t-sub">Image</div></div>
        </div>
        <div class="type-btn" id="type-video" onclick="toggleType('video')">
          <span class="t-icon">üé¨</span><div><div class="t-label">‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</div><div class="t-sub">Video</div></div>
        </div>
        <div class="type-btn active" id="type-flex" onclick="toggleType('flex')">
          <span class="t-icon">‚ú®</span><div><div class="t-label">Flex Card</div><div class="t-sub">Bubble / Carousel</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- TEXT SECTION -->
  <section class="msg-section" id="section-text">
    <div class="section-label">üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</div>
    <div class="fields">
      <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°<textarea id="txt-msg" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea></label>
    </div>
  </section>

  <!-- IMAGE SECTION -->
  <section class="msg-section" id="section-image">
    <div class="section-label">üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
    <div class="fields">
      <label>URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (jpg/png)<input id="img-url" type="text" placeholder="https://..." /></label>
      <label>URL ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏£‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)<input id="img-link" type="text" placeholder="https://..." /></label>
    </div>
  </section>

  <!-- VIDEO SECTION -->
  <section class="msg-section" id="section-video">
    <div class="section-label">üé¨ ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</div>
    <div class="fields">
      <label>URL ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (.mp4)<input id="vid-url" type="text" placeholder="https://...mp4" /></label>
      <label>URL ‡∏£‡∏π‡∏õ Thumbnail (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)<input id="vid-thumb" type="text" placeholder="https://..." /></label>
    </div>
  </section>

  <!-- Send -->
  <section>
    <div class="section-label">üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
    <div class="fields">
      <button class="send-btn" onclick="sendAll()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô LINE
      </button>
      <div id="status"></div>
      <p class="tip">‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î picker ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡∏´‡∏≤‡πÉ‡∏Ñ‡∏£<br>‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE LIFF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
    </div>
  </section>

  <div class="spacer"></div>
</div>

<script>
let themeColor = '#06C755';
let liffReady = false;
let selectedTypes = new Set(['flex']);
let activeCard = 0;
let cardCount = 1;
let cardColors = ['#06C755'];
let cardButtons = {}; // {i: [{label,url,style}]}

const COLORS = ['#06C755','#e11d48','#f97316','#8b5cf6','#0ea5e9','#1a1a1a'];

// ---- LIFF Init ----
async function initLiff() {
  const id = document.getElementById('liff-id-input').value.trim();
  if (!id) return showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å LIFF ID', 'error', 'setup');
  showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'info', 'setup');
  try {
    await liff.init({ liffId: id });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    localStorage.setItem('liff_id', id);
    liffReady = true;
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    initCards();
  } catch (e) {
    showStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e.message, 'error', 'setup');
  }
}

window.addEventListener('load', async () => {
  const saved = localStorage.getItem('liff_id');
  if (saved) {
    document.getElementById('liff-id-input').value = saved;
    try {
      await liff.init({ liffId: saved });
      if (liff.isLoggedIn()) {
        liffReady = true;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        initCards();
        return;
      }
    } catch(e) {}
  }
});

// ---- Type Selector ----
function toggleType(t) {
  const btn = document.getElementById('type-' + t);
  const sec = document.getElementById('section-' + t);
  if (selectedTypes.has(t)) {
    selectedTypes.delete(t);
    btn.classList.remove('active');
    if (sec) sec.classList.remove('visible');
  } else {
    selectedTypes.add(t);
    btn.classList.add('active');
    if (sec) sec.classList.add('visible');
  }
  // Show/hide preview only when flex is selected
  document.getElementById('preview-section').style.display = selectedTypes.has('flex') ? 'block' : 'none';
}

// ---- Card / Carousel ----
function initCards() {
  cardCount = 1;
  cardColors = ['#06C755'];
  cardButtons = {};
  activeCard = 0;
  renderTabs();
  renderCards();
}

function updateCardCount() {
  const n = parseInt(document.getElementById('card-count').value);
  while (cardColors.length < n) cardColors.push('#06C755');
  cardColors = cardColors.slice(0, n);
  cardCount = n;
  if (activeCard >= n) activeCard = 0;
  renderTabs();
  renderCards();
}

function renderTabs() {
  const wrap = document.getElementById('card-tabs');
  if (cardCount <= 1) { wrap.innerHTML = ''; return; }
  wrap.innerHTML = Array.from({length: cardCount}, (_, i) =>
    `<div class="card-tab ${i===activeCard?'active':''}" onclick="switchCard(${i})">‡∏Å‡∏≤‡∏£‡πå‡∏î ${i+1}</div>`
  ).join('');
}

function switchCard(i) {
  activeCard = i;
  renderTabs();
  document.querySelectorAll('.card-form').forEach((f, idx) => {
    f.classList.toggle('visible', idx === i);
  });
  renderPreview();
}

function renderCards() {
  const container = document.getElementById('cards-container');
  container.innerHTML = '';
  for (let i = 0; i < cardCount; i++) {
    const div = document.createElement('div');
    div.className = 'card-form' + (i === activeCard ? ' visible' : '');
    div.innerHTML = cardHTML(i);
    container.appendChild(div);
    // init buttons
    if (!cardButtons[i]) cardButtons[i] = [{label: '‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡∏¢!', url: 'https://example.com', style: 'primary'}];
    renderBtnList(i);
  }
  renderPreview();
}

function cardHTML(i) {
  const tc = cardColors[i] || '#06C755';
  return `
    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô / ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å
      <input id="c${i}-title" type="text" value="Flash Sale 50% OFF!" oninput="renderPreview()" />
    </label>
    <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
      <textarea id="c${i}-desc" oninput="renderPreview()">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏•‡∏î 50% ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!</textarea>
    </label>
    <div class="row">
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©<input id="c${i}-price" type="text" value="‡∏ø499" oninput="renderPreview()" /></label>
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°<input id="c${i}-original" type="text" value="‡∏ø999" oninput="renderPreview()" /></label>
    </div>
    <label>Badge / Tag<input id="c${i}-tag" type="text" value="üî• FLASH SALE" oninput="renderPreview()" /></label>
    <label>URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û<input id="c${i}-img" type="text" value="https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=800" oninput="renderPreview()" /></label>
    <label>‡∏™‡∏µ‡∏ò‡∏µ‡∏°
      <div class="color-options" id="c${i}-colors">
        ${COLORS.map(c => `<div class="color-swatch ${c===tc?'active':''}" data-color="${c}" style="background:${c};${c==='#1a1a1a'?'border:1px solid #444':''}" onclick="pickCardColor(${i},this)"></div>`).join('')}
      </div>
    </label>
    <div style="font-size:12px;color:var(--text-muted);font-weight:700;margin-bottom:2px">üîò ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</div>
    <div class="btn-list" id="c${i}-btnlist"></div>
    <button class="add-field-btn" onclick="addBtn(${i})">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°</button>
  `;
}

function renderBtnList(i) {
  const el = document.getElementById('c' + i + '-btnlist');
  if (!el) return;
  const btns = cardButtons[i] || [];
  el.innerHTML = btns.map((b, j) => `
    <div class="btn-item">
      <div class="btn-item-header">
        <span>‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${j+1}</span>
        <button class="remove-btn" onclick="removeBtn(${i},${j})">√ó</button>
      </div>
      <div class="row">
        <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°<input type="text" value="${b.label}" oninput="updBtn(${i},${j},'label',this.value)" /></label>
        <label>‡∏™‡πÑ‡∏ï‡∏•‡πå
          <select onchange="updBtn(${i},${j},'style',this.value)">
            <option value="primary" ${b.style==='primary'?'selected':''}>Primary (‡∏™‡∏µ)</option>
            <option value="secondary" ${b.style==='secondary'?'selected':''}>Secondary (‡∏Ç‡∏≠‡∏ö)</option>
            <option value="link" ${b.style==='link'?'selected':''}>Link (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</option>
          </select>
        </label>
      </div>
      <label>URL<input type="text" value="${b.url}" oninput="updBtn(${i},${j},'url',this.value)" /></label>
    </div>`).join('');
  renderPreview();
}

function addBtn(i) {
  if (!cardButtons[i]) cardButtons[i] = [];
  cardButtons[i].push({label: '‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°', url: 'https://example.com', style: 'secondary'});
  renderBtnList(i);
}

function removeBtn(i, j) {
  cardButtons[i].splice(j, 1);
  renderBtnList(i);
}

function updBtn(i, j, field, val) {
  if (cardButtons[i] && cardButtons[i][j]) cardButtons[i][j][field] = val;
  renderPreview();
}

function pickCardColor(i, el) {
  document.querySelectorAll('#c' + i + '-colors .color-swatch').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  cardColors[i] = el.dataset.color;
  renderPreview();
}

// ---- Preview ----
function getCardData(i) {
  return {
    title:    document.getElementById(`c${i}-title`)?.value || '',
    desc:     document.getElementById(`c${i}-desc`)?.value || '',
    price:    document.getElementById(`c${i}-price`)?.value || '',
    original: document.getElementById(`c${i}-original`)?.value || '',
    tag:      document.getElementById(`c${i}-tag`)?.value || '',
    img:      document.getElementById(`c${i}-img`)?.value || '',
    color:    cardColors[i] || '#06C755',
    buttons:  cardButtons[i] || []
  };
}

function bubblePreviewHTML(d) {
  const tc = d.color;
  const btns = d.buttons.map(b => {
    if (b.style === 'secondary') return `<div class="preview-btn-secondary" style="color:${tc};border-color:${tc}">${b.label}</div>`;
    if (b.style === 'link') return `<div class="preview-btn-link" style="color:${tc}">${b.label}</div>`;
    return `<div class="preview-btn" style="background:${tc}">${b.label}</div>`;
  }).join('');
  return `
    <div class="bubble-preview">
      ${d.img ? `<img class="preview-hero" src="${d.img}" onerror="this.style.display='none'" />`
               : `<div class="preview-hero-placeholder" style="background:${tc}">üñº ‡πÉ‡∏™‡πà URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>`}
      <div class="preview-body">
        ${d.tag ? `<span class="preview-tag" style="background:${tc}">${d.tag}</span>` : ''}
        <div class="preview-title">${d.title}</div>
        <div class="preview-desc">${d.desc}</div>
        <div class="preview-price-row">
          <span class="preview-price" style="color:${tc}">${d.price}</span>
          ${d.original ? `<span class="preview-original">${d.original}</span>` : ''}
        </div>
        ${btns}
      </div>
    </div>`;
}

function renderPreview() {
  const wrap = document.getElementById('preview-wrap');
  if (cardCount === 1) {
    wrap.innerHTML = `<div style="padding:16px">${bubblePreviewHTML(getCardData(0))}</div>`;
  } else {
    wrap.innerHTML = `<div class="carousel-preview-scroll">${
      Array.from({length: cardCount}, (_, i) => bubblePreviewHTML(getCardData(i))).join('')
    }</div>`;
  }
}

// ---- Build Flex JSON ----
function buildBubble(d) {
  const body = [];
  if (d.tag) body.push({type:"box",layout:"horizontal",contents:[{type:"text",text:d.tag,size:"xs",color:"#ffffff",weight:"bold"}],backgroundColor:d.color,paddingAll:"6px",cornerRadius:"4px"});
  body.push({type:"text",text:d.title||' ',weight:"bold",size:"xl",wrap:true,color:"#1a1a1a",margin:d.tag?"md":"none"});
  if (d.desc) body.push({type:"text",text:d.desc,size:"sm",wrap:true,color:"#888888",margin:"sm"});
  if (d.price) {
    const row = {type:"box",layout:"baseline",margin:"md",contents:[{type:"text",text:d.price,size:"xxl",weight:"bold",color:d.color,flex:0}]};
    if (d.original) row.contents.push({type:"text",text:d.original,size:"sm",color:"#bbbbbb",decoration:"line-through",margin:"sm",flex:0});
    body.push(row);
  }
  const footerContents = d.buttons.map(b => ({
    type:"button",
    action:{type:"uri",label:b.label,uri:b.url||'https://example.com'},
    style: b.style === 'primary' ? 'primary' : b.style === 'secondary' ? 'secondary' : 'link',
    color: b.style === 'primary' ? d.color : undefined,
    height:"sm"
  }));
  const bubble = {
    type:"bubble",
    body:{type:"box",layout:"vertical",contents:body,spacing:"sm"},
    footer:{type:"box",layout:"vertical",contents:footerContents,spacing:"sm"}
  };
  if (d.img) bubble.hero = {type:"image",url:d.img,size:"full",aspectRatio:"20:13",aspectMode:"cover"};
  return bubble;
}

function buildFlexMsg() {
  const cards = Array.from({length: cardCount}, (_, i) => buildBubble(getCardData(i)));
  const altText = getCardData(0).title || '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô';
  if (cardCount === 1) return {type:"flex", altText, contents: cards[0]};
  return {type:"flex", altText, contents:{type:"carousel", contents: cards}};
}

// ---- Send All ----
async function sendAll() {
  if (!liffReady) return showStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE', 'error', 'app');
  if (selectedTypes.size === 0) return showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'error', 'app');
  if (!liff.isApiAvailable('shareTargetPicker')) return showStatus('shareTargetPicker ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ', 'error', 'app');

  const msgs = [];
  if (selectedTypes.has('text')) {
    const t = document.getElementById('txt-msg')?.value.trim();
    if (t) msgs.push({type:'text', text:t});
  }
  if (selectedTypes.has('image')) {
    const u = document.getElementById('img-url')?.value.trim();
    if (u) msgs.push({type:'image', originalContentUrl:u, previewImageUrl:u});
  }
  if (selectedTypes.has('video')) {
    const u = document.getElementById('vid-url')?.value.trim();
    const th = document.getElementById('vid-thumb')?.value.trim();
    if (u && th) msgs.push({type:'video', originalContentUrl:u, previewImageUrl:th});
  }
  if (selectedTypes.has('flex')) msgs.push(buildFlexMsg());

  if (msgs.length === 0) return showStatus('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á', 'error', 'app');

  try {
    const result = await liff.shareTargetPicker(msgs, {isMultiple: true});
    if (result) showStatus('‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! (' + msgs.length + ' ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)', 'success', 'app');
    else showStatus('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á', 'info', 'app');
  } catch (e) {
    showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error', 'app');
  }
}

// ---- Status helper ----
function showStatus(msg, type, scope) {
  const el = scope === 'setup'
    ? document.querySelector('#setup-screen #status')
    : document.querySelector('#app #status');
  if (!el) return;
  el.textContent = msg;
  el.className = type;
}
</script>
</body>
</html>
